<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>問卷生成與上傳</title>
  <script>
    var questionnaire = {
      resourceType: "Questionnaire",
      id: "GeneratedQuestionnaire",
      item: []
    };

    // 自行實作的 CSV 解析函數
    function parseCSV(csvString) {
  const rows = csvString.split("\n").map(row => row.trim());
  const headers = rows[0].split(",");
  const data = rows.slice(1).map(row => {
    const values = row.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g); // 處理引號與逗號
    return headers.reduce((acc, header, index) => {
      const value = values ? values[index] : "";
      acc[header] = value ? value.replace(/^"|"$/g, "") : ""; // 只有在 value 存在時才進行處理
      return acc;
    }, {});
  });
  return data;
}


    function handleFileUpload(event) {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function (e) {
          const csvData = e.target.result;
          const parsedData = parseCSV(csvData);
          updateQuestionnaire(parsedData);
        };
        reader.readAsText(file, "big5");
      }
    }

    function updateQuestionnaire(parsedData) {
  questionnaire.item = parsedData
    .filter(row => row.linkId && row.text && row.type) // 過濾掉空值的項目
    .map(row => {
      const question = {
        linkId: row.linkId.trim(),
        text: row.text.trim(),
        type: row.type.trim()
      };

      // 根據不同的類型處理選項
      if (row.type.trim() === "choice" || row.type.trim() === "multiple") {
        question.option = row.options.split(",").map(option => option.trim());
      }

      return question;
    });

  displayQuestions();
}


    function displayQuestions() {
      const container = document.getElementById("questionnaire");
      container.innerHTML = "";
      questionnaire.item.forEach((question, index) => {
        const questionDiv = document.createElement("div");
        questionDiv.innerText = `${index + 1}. ${question.text}`;
        container.appendChild(questionDiv);
      });
    }

    function generateJSON() {
      const jsonContainer = document.getElementById("jsonOutput");
      jsonContainer.innerHTML = "<pre>" + JSON.stringify(questionnaire, null, 2) + "</pre>";
    }
  </script>
</head>
<body>
  <h2>問卷生成與上傳</h2>
  <div>
    <label>上傳 CSV 檔案：</label>
    <input type="file" accept=".csv" onchange="handleFileUpload(event)" />
  </div>
  <div id="questionnaire" style="margin-top: 20px;"></div>
  <div>
    <button onclick="generateJSON()">生成 JSON</button>
  </div>
  <div id="jsonOutput" style="margin-top: 20px; border: 1px solid #ccc; padding: 10px;"></div>
</body>
</html>
